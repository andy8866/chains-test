## chains-test 示例项目测试覆盖说明

本项目用于在本地通过 `chains-sdk` 对 Tron 网络（主要是 Nile 测试网）做集成级别的验证。  
它本身不包含单元测试，而是通过 **实际调用远程 RPC / 链上数据** 来验证 SDK 的关键功能是否按预期工作。

> 注意：`chains-sdk` 仓库自身已经有详细的单测覆盖，详见该仓库下的 `docs/测试覆盖.md`。  
> 本文档仅描述 **chains-test 这个示例项目** 在“真实网络”上的测试覆盖情况。

---

## 1. 账户相关

- **TRX 余额查询（只读链上数据）**
  - 对应命令：`cargo run -- balance`
  - 覆盖内容：
    - 使用 `TronChain::nile()` 创建 Tron Nile 测试网链实例。
    - 通过 `BalanceProvider::get_balance` 调用 Tron RPC，读取指定地址的 TRX 余额。
  - 验证点：
    - 能正常连接 Nile 测试网的公共 RPC。
    - 返回的余额字段可被正确解析并打印。

---

## 2. TRC20 代币相关（只读 + 构建交易）

- **TRC20 代币信息查询（只读）**
  - 对应命令：
    ```bash
    export TRC20_CONTRACT_ADDRESS=<TRC20合约地址>
    cargo run -- trc20
    ```
  - 覆盖内容：
    - 使用 `TronChain::nile()` 与 `TronRpcProvider::from_network(TronNetwork::Nile)`。
    - 调用统一 TRC20 API：
      - `trc20_balance_of`
      - `trc20_symbol`
      - `trc20_decimals`
      - `trc20_name`
      - `trc20_total_supply`
  - 验证点：
    - 针对真实合约地址，RPC 调用能成功返回数据。
    - SDK 能正确解析 TRC20 代币的元数据与余额。

- **TRC20 转账交易构建（本地构建，不广播）**
  - 同样通过 `cargo run -- trc20` 触发。
  - 覆盖内容：
    - 使用 `trc20_build_transfer` 根据：
      - `from` 地址
      - `to` 地址
      - 合约地址
      - 原始金额字符串（如 `"1000000"`）
      - `fee_limit`
      构建一笔 TRC20 转账交易 JSON。
  - 验证点：
    - SDK 能成功生成结构完整的交易 JSON（长度、关键字段存在性）。
    - 该 JSON 可作为后续签名 / 广播的输入。

- **TRC20 转账交易构建（需要广播）**
  - 流程拆分为两步：
    1. **在本项目中构建原始 TRC20 转账交易 JSON（未签名）**
       - 使用 `cargo run -- trc20`，查看控制台中“构建 TRC20 转账交易成功”对应的 JSON（可在代码中临时打印或写入文件）。
    2. **在外部环境完成签名并通过 `send-signed` 广播**
       - 使用你自己的钱包 / 后端服务对上一步的原始交易 JSON 做签名，得到带 `signature` 字段的完整 JSON。
       - 使用本项目的：
         - `SIGNED_TX_JSON` 或 `SIGNED_TX_PATH` 将已签名 JSON 传入，
         - 运行 `cargo run -- send-signed` 完成**真实广播 + 等待确认**。
  - 验证点：
    - 从“TRC20 构建”到“真实广播”的整条链路打通：
      - `trc20_build_transfer` 生成的交易结构可被外部签名方正确识别。
      - 已签名的 TRC20 转账交易能被 `send-signed` 成功发送，并能拿到最终确认状态。

> 说明：以上 TRC20 相关测试使用真实的合约地址与 RPC，但不在本项目内管理私钥或执行签名，仅验证“查询 + 构建”的行为。

- **方案 B：全自动 TRC20 流程（构建 → 私钥签名 → 广播 → 监听）**
  - 对应命令：
    ```bash
    export TRON_PRIVATE_KEY=64位十六进制私钥
    export TRC20_CONTRACT_ADDRESS=<TRC20合约地址>
    cargo run -- full-flow
    ```
  - 覆盖内容：
    1. 使用 `trc20_build_transfer` 向 Tron Nile 节点获取未签名交易 JSON（含 `txID`）。
    2. 使用本项目内的 `sign_tron_transaction`：对 `txID`（32 字节）做 ECDSA secp256k1 可恢复签名，得到 65 字节（r+s+v），转 hex 写入 `transaction.signature`。
    3. 使用 `TransactionSender::send` 广播已签名 JSON。
    4. 使用 `TransactionMonitor::wait_for_confirmation_with_timeout` 轮询直至 **Confirmed / Failed / Pending**。
  - 验证点：
    - 从“构建 → 签名 → 广播 → 监听”的整条链路在 Tron Nile 测试网上可一次跑通。
    - 私钥仅用于本地签名，不离开本机；适合测试网验证 SDK 与签名格式。

---

## 3. 交易状态监听（只读链上数据）

- **按交易哈希监听确认状态**
  - 对应命令：
    ```bash
    export TX_HASH=<交易哈希>
    cargo run -- monitor
    ```
  - 覆盖内容：
    - 使用 `TransactionMonitor`：
      - `wait_for_confirmation(tx_hash, Some(10), Some(3000))`
    - 连续向 Tron Nile 节点轮询交易状态。
  - 验证点：
    - 针对真实存在的交易哈希，能拿到 `Confirmed / Failed / Pending` 三种状态之一。
    - `TransactionStatus` 枚举在真实网络场景下的行为符合预期。

---

## 4. 交易发送与确认（真实上链）

### 4.1 示例发送（假数据，仅接口演示）

- **send-demo：使用假 `raw_tx` 演示接口调用**
  - 对应命令：
    ```bash
    cargo run -- send-demo
    ```
  - 覆盖内容：
    - 以示例 JSON 作为 `raw_tx` 调用：
      - `TransactionSender::send`
      - `TransactionMonitor::wait_for_confirmation_with_timeout`
  - 验证点：
    - 不要求交易一定成功上链，主要验证接口在异常场景下不会 panic，错误信息可读。

### 4.2 真实上链：发送已签名交易

- **send-signed：发送用户自行签名好的交易到链上并等待确认**
  - 对应命令（两种方式其一）：
    - 方式一：直接用环境变量传 JSON
      ```bash
      export SIGNED_TX_JSON='{"raw_data":{...},"signature":[...]}'
      cargo run -- send-signed
      ```
    - 方式二：从文件读取 JSON
      ```bash
      echo '{"raw_data":{...},"signature":[...]}' > signed_tx.json
      export SIGNED_TX_PATH=$(pwd)/signed_tx.json
      cargo run -- send-signed
      ```
  - 覆盖内容：
    - 从环境变量或文件中读取**完整的已签名交易 JSON**。
    - 使用 `TransactionSender::send` 向 Tron Nile 节点广播该交易。
    - 使用 `TransactionMonitor::wait_for_confirmation_with_timeout` 轮询直至：
      - 交易确认（`Confirmed`）
      - 交易失败（`Failed`）
      - 超时仍未确认（`Pending`）
  - 验证点：
    - SDK 在真实链上处理完整交易生命周期的行为：
      - 广播已签名交易（不参与签名过程）。
      - 正确解析返回的交易哈希。
      - 正确追踪并解释最终状态。

> 安全说明：  
> - 本项目 **不负责生成或存储私钥**，仅使用你提供的“已签名交易 JSON”。  
> - 这样可以在不暴露私钥的前提下，验证 chains-sdk 在真实网络上的发送与确认流程。

---

## 5. 不在本项目范围内的测试

以下内容主要通过 `chains-sdk` 仓库自身的单元测试/集成测试覆盖，本示例项目仅间接使用，不做细粒度验证：

- Tron 相关底层类型的构造逻辑（请求体结构、默认字段等）。
- 所有 HTTP 客户端内部的错误分支与重试策略。
- 复杂的 TRC20 高阶封装方法：
  - 如 `trc20_transfer_and_wait` / `trc20_approve_and_wait` 等。
- 其它链（Ethereum / BSC / Bitcoin / Solana 等）的网络与交易行为。

---

## 6. 总结

`chains-test` 项目提供的是一组 **基于 Tron Nile 测试网的、端到端的人工验证入口**，重点覆盖：

- 账户余额查询
- TRC20 代币信息读取与交易构建
- 交易状态监听
- 已签名交易的真实广播与确认

它适合作为：

- 本地开发时验证 chains-sdk 是否能在当前网络环境下正常工作。
- 手工测试新版本 SDK 的兼容性（特别是 Tron 相关改动）。
- 调试你自己的“构建并签名交易”逻辑是否与 chains-sdk 的发送/监听流程兼容。

