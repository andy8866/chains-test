# chains-test 功能与代码结构

本文档说明本项目的 **SDK 代码结构**、**模块职责** 与 **功能清单**，便于理解示例如何调用 `chains-sdk`。

---

## 一、项目结构

```
chains-test/
├── Cargo.toml           # 依赖：chains-sdk（path="../chains"）、tokio、serde_json
├── README.md            # 项目介绍、命令一览、快速示例
├── run_verify.py        # （可选）Python 验证脚本
├── docs/
│   ├── 测试说明.md      # 各命令环境变量与预期结果
│   └── 功能与代码结构.md # 本文档
└── src/
    ├── main.rs          # 入口、CLI 分发、TRX 余额、Tron 交易监听
    ├── config.rs        # 环境与网络配置、示例地址、EVM RPC 选取
    ├── trc20.rs         # Tron：TRX/TRC20 只读、构建、签名广播、全流程
    └── erc20.rs         # EVM：原生 ETH / ERC20 只读、构建、签名广播、全流程
```

---

## 二、模块职责与功能

### 1. main.rs

| 职责 | 说明 |
|------|------|
| 入口 | `#[tokio::main]` 异步 main，解析 `cargo run -- <命令>` 的第一个参数 |
| CLI 分发 | 根据子命令调用 `trc20::*` 或 `erc20::*`，或执行本模块内的 `run_tron_balance` / `run_tron_monitor` |
| 帮助 | `print_usage()` 输出网络选择说明与命令列表 |

**本模块实现的命令：**

- **tron-balance**：使用 `BalanceProvider` + `TronChain` 查询示例地址 TRX 余额
- **tron-monitor**：使用 `TransactionMonitor` 按 `TX_HASH` 轮询 Tron 交易确认状态

**依赖的 SDK：**

- `chains_sdk::balance::BalanceProvider`
- `chains_sdk::chain::tron::TronChain`
- `chains_sdk::transaction::{TransactionMonitor, TransactionStatus}`

---

### 2. config.rs

| 职责 | 说明 |
|------|------|
| 网络选择 | 从环境变量解析 `TRON_NETWORK`（nile/mainnet/shasta）、`EVM_NETWORK`（sepolia/arbitrum-sepolia/arbitrum-one/mainnet） |
| 示例地址 | `TRON_EXAMPLE_ADDR`、`EVM_EXAMPLE_ADDR`（与 run_verify.py 一致） |
| EVM RPC | 未设置 `EVM_RPC_URL` 时，从 SDK 该网络备选 RPC 列表健康检查（8 秒超时）选取第一个可用 URL |

**对外接口：**

- `current_tron_network() -> TronNetwork`
- `current_evm_network() -> EvmNetwork`
- `evm_rpc_url(network) -> String`（async）

**依赖的 SDK：**

- `chains_sdk::rpc::chains::evm::{EvmNetwork, EvmRpcProvider}`
- `chains_sdk::rpc::chains::tron::TronNetwork`
- `chains_sdk::rpc::RpcProvider`

---

### 3. trc20.rs（Tron）

| 职责 | 说明 |
|------|------|
| 只读查询 | TRC20 余额、符号、精度、名称、总供应、授权；TRC20 token_info |
| 构建交易 | TRC20 transfer / approve / transfer_from（不签名不广播） |
| TRX 原生 | 构建 TRX 转账、签名、广播、等待确认 |
| TRC20 全流程 | 构建 TRC20 转账、签名、广播、等待确认 |
| 验证 | `tron-verify-trc20` 逐项调用 SDK TRC20 接口并输出 ✅/❌ |

**本模块实现的命令：**

| 命令 | 功能概要 |
|------|----------|
| `tron-trc20` | 代币信息 + 构建 TRC20 转账（不签名不广播） |
| `tron-usdt-balance` | 按 `TRON_NETWORK` 对应 USDT 合约查指定地址余额 |
| `tron-verify-trc20` | 验证 10 个 TRC20 API（balance_of、symbol、decimals、name、total_supply、allowance、token_info、build_transfer、build_approve、build_transfer_from） |
| `tron-transfer` | TRX 转账：构建 → 签名 → 广播 → 等待确认（可配置区块确认数） |
| `tron-full-flow` | TRC20 全自动：构建 → 签名 → 广播 → 等待确认 |

**依赖的 SDK：**

- `chains_sdk::chain::tron::{sign_tron_transaction, TronChain}`
- `chains_sdk::rpc::chains::tron::TronRpcProvider`
- `chains_sdk::transaction::{TransactionMonitor, TransactionSender, TransactionStatus}`

---

### 4. erc20.rs（EVM / ERC20）

| 职责 | 说明 |
|------|------|
| 原生 ETH | 余额查询、构建原生转账、签名、广播、等待确认 |
| 只读查询 | ERC20 余额、符号、精度、名称、总供应、授权；ERC20 token_info |
| 构建交易 | ERC20 transfer / approve / transfer_from（不签名不广播） |
| ERC20 全流程 | 按人类可读金额（如 120 USDT）换算最小单位后构建、签名、广播、等待确认 |
| 验证 | `erc20-verify` 逐项调用 SDK ERC20 接口并输出 ✅/❌ |

**本模块实现的命令：**

| 命令 | 功能概要 |
|------|----------|
| `eth-balance` | 当前 EVM 网络原生 ETH 余额 |
| `eth-transfer` | 原生 ETH 转账：构建 → 签名 → 广播 → 等待确认 |
| `eth-monitor` | 按 `TX_HASH` 轮询 EVM 交易确认（支持超时与最少确认数） |
| `erc20-demo` | ERC20 代币信息 + 构建转账（不签名不广播） |
| `erc20-verify` | 验证 10 个 ERC20 API（与 TRC20 对应） |
| `erc20-full-flow` | ERC20 全自动：按精度换算金额 → 构建 → 签名 → 广播 → 等待确认 |

**依赖的 SDK：**

- `chains_sdk::chain::evm::{ethereum_address_from_private_key, sign_ethereum_transaction, EvmChain}`
- `chains_sdk::Blockchain`
- `chains_sdk::rpc::chains::evm::{EvmNetwork, EvmRpcProvider}`
- `chains_sdk::transaction::{TransactionMonitor, TransactionSender, TransactionStatus}`

**辅助：** `human_amount_to_raw(human, decimals)` 将人类可读数量（如 `"120"`）按精度换算为最小单位字符串。

---

## 三、功能与 SDK 接口对应

### Tron（TRX / TRC20）

| 功能 | 本示例命令 | 主要 SDK 用法 |
|------|------------|----------------|
| TRX 余额 | `tron-balance` | `BalanceProvider::get_balance` |
| TRC20 余额/元数据 | `tron-trc20`、`tron-usdt-balance` | `TronChain::trc20_balance_of`、`trc20_symbol`、`trc20_decimals`、`trc20_name`、`trc20_total_supply`、`trc20_token_info` |
| TRC20 授权 | `tron-verify-trc20` | `TronChain::trc20_allowance` |
| 构建 TRC20 交易 | `tron-trc20`、`tron-full-flow` | `TronChain::trc20_build_transfer`、`trc20_build_approve`、`trc20_build_transfer_from` |
| 构建 TRX 转账 | `tron-transfer` | `TronChain::trx_build_transfer` |
| 签名 | `tron-transfer`、`tron-full-flow` | `sign_tron_transaction` |
| 广播与监听 | `tron-transfer`、`tron-full-flow`、`tron-monitor` | `TransactionSender::send`、`TransactionMonitor::wait_for_confirmation*` |

### EVM（ETH / ERC20）

| 功能 | 本示例命令 | 主要 SDK 用法 |
|------|------------|----------------|
| 原生 ETH 余额 | `eth-balance` | `EvmChain::get_balance`（通过 `Blockchain`） |
| 原生 ETH 转账 | `eth-transfer` | `EvmChain::evm_build_native_transfer`、`sign_ethereum_transaction`、`TransactionSender::send`、`TransactionMonitor::wait_for_confirmation*` |
| ERC20 余额/元数据 | `erc20-demo`、`erc20-verify` | `EvmChain::erc20_balance_of`、`erc20_symbol`、`erc20_decimals`、`erc20_name`、`erc20_total_supply`、`erc20_token_info`、`erc20_allowance` |
| 构建 ERC20 交易 | `erc20-demo`、`erc20-full-flow` | `EvmChain::erc20_build_transfer`、`erc20_build_approve`、`erc20_build_transfer_from` |
| 签名与广播 | `eth-transfer`、`erc20-full-flow` | `sign_ethereum_transaction`、`TransactionSender::send` |
| 监听交易 | `eth-monitor` | `TransactionMonitor::wait_for_confirmation_with_timeout` |

---

## 四、环境变量汇总

| 变量 | 适用命令 | 说明 |
|------|----------|------|
| `TRON_NETWORK` | 所有 Tron 命令 | nile（默认）/ mainnet / shasta |
| `EVM_NETWORK` | 所有 EVM/ERC20 命令 | sepolia（默认）/ arbitrum-sepolia / arbitrum-one / mainnet |
| `EVM_RPC_URL` | 所有 EVM/ERC20 命令 | 覆盖 RPC；未设置时从 SDK 备选健康检查选取 |
| `TRON_PRIVATE_KEY` | tron-transfer、tron-full-flow | 64 位十六进制私钥（必填） |
| `TRC20_CONTRACT_ADDRESS` | tron-trc20、tron-full-flow、tron-verify-trc20 | TRC20 合约地址（可选，默认 SDK 当前网络 USDT） |
| `TRON_ADDRESS` | tron-usdt-balance | 查询 USDT 的地址（必填） |
| `TRON_FROM_ADDRESS` / `TRON_TO_ADDRESS` | tron-transfer、tron-full-flow | 发送/接收地址（可选） |
| `TRX_AMOUNT_SUN` | tron-transfer | TRX 金额 sun（可选） |
| `TRC20_AMOUNT` / `TRC20_FEE_LIMIT` | tron-full-flow | 金额最小单位、fee limit（可选） |
| `TX_HASH` | tron-monitor、eth-monitor | 要监听的交易哈希（必填） |
| `ETH_PRIVATE_KEY` | eth-transfer、erc20-full-flow | 64 位十六进制私钥（必填） |
| `ETH_ADDRESS` | eth-balance | 查询余额的地址（可选） |
| `ETH_FROM_ADDRESS` / `ETH_TO_ADDRESS` | eth-transfer、erc20-full-flow | 发送/接收地址（可选） |
| `ETH_AMOUNT_WEI` | eth-transfer | 转账 wei（可选） |
| `ERC20_CONTRACT_ADDRESS` | erc20-demo、erc20-verify、erc20-full-flow | ERC20 合约（可选，默认 SDK 当前网络 USDT） |
| `ERC20_AMOUNT` | erc20-full-flow | 人类可读数量，如 120（按精度换算）（可选） |
| `MONITOR_TIMEOUT_SEC` / `MONITOR_MIN_CONFIRMATIONS` | eth-monitor | 超时秒数、最少确认数（可选） |

---

## 五、相关文档

- **README.md** — 项目介绍、代码结构概览、命令一览、快速示例
- **docs/测试说明.md** — 各命令详细环境变量、预期结果、推荐测试顺序与常见问题
