# chains-test 测试说明

本文档说明如何运行本项目中的各项测试命令、所需环境变量及预期结果。  
项目基于 **Tron Nile 测试网**、**Ethereum Sepolia 测试网** 与 **Arbitrum Sepolia 测试网**，通过实际 RPC 调用验证 `chains-sdk` 行为。

---

## 前置条件

- 已安装 Rust / Cargo（建议 `rustup`）
- 同级目录存在 `chains`（chains-sdk）项目，且 `Cargo.toml` 中 `chains-sdk = { path = "../chains" }` 可解析
- 网络可访问 Tron 公共 RPC（如 `nile.trongrid.io`）、Sepolia 公共 RPC 及 Arbitrum Sepolia 公共 RPC（如 `sepolia-rollup.arbitrum.io`）

**网络选择：**

- **TRON_NETWORK**：Tron 网络，可选 `nile`（默认）、`mainnet`、`shasta`。所有 `tron-*` 命令均按此变量选择网络。
- **EVM_NETWORK**：EVM 网络，可选 `sepolia`（默认）、`arbitrum-sepolia`、`arbitrum-one`、`mainnet`。所有 `eth-*`、`erc20-*` 命令均按此变量选择网络。未设置 `EVM_RPC_URL` 时，程序会从 SDK 提供的该网络备选 RPC 中依次尝试直到可用（单次健康检查 8 秒超时）。

---

## 命令一览

### Tron（网络由 TRON_NETWORK 指定，默认 nile）

| 命令 | 说明 |
|------|------|
| `tron-balance` | 查询 TRX 余额 |
| `tron-trc20` | TRC20 代币信息 + 构建转账（不签名不广播） |
| `tron-usdt-balance` | 查询 USDT 余额（按 TRON_NETWORK 对应网络的 USDT 合约） |
| `tron-verify-trc20` | 按 SDK 验证全部 TRC20 API |
| `tron-transfer` | TRX 原生转账：构建→签名→广播→监听 |
| `tron-full-flow` | 全自动 TRC20：构建→签名→广播→监听 |
| `tron-monitor` | 按交易哈希监听 Tron 交易（TX_HASH） |

### EVM 原生 ETH（网络由 EVM_NETWORK 指定，默认 sepolia）

| 命令 | 说明 |
|------|------|
| `eth-balance` | 查询原生 ETH 余额 |
| `eth-transfer` | 原生 ETH 转账全流程：构建→签名→广播→监听 |
| `eth-monitor` | 按交易哈希监听交易（含 ETH/ERC20） |

### ERC20（网络由 EVM_NETWORK 指定）

| 命令 | 说明 |
|------|------|
| `erc20-demo` | ERC20 代币信息 + 构建转账（不签名不广播） |
| `erc20-verify` | 按 SDK 验证全部 ERC20 API |
| `erc20-full-flow` | 全自动 ERC20：构建→签名→广播→监听 |

**EVM 网络说明：** `arbitrum-sepolia`（链 ID 421614）、`arbitrum-one`（链 ID 42161）、`mainnet`（以太坊主网，链 ID 1）。各网络默认 ERC20 合约见 SDK `EvmNetwork`。

### 其他

| 命令 | 说明 |
|------|------|
| `help` / `-h` / `--help` | 显示命令列表与用法，例如：`cargo run -- help` |

---

## 一、Tron 命令

### 1. tron-balance — TRX 余额查询

**命令：**
```bash
cargo run -- tron-balance
# 或指定网络：export TRON_NETWORK=mainnet && cargo run -- tron-balance
```

**环境变量：** `TRON_NETWORK`（可选，默认 `nile`）；无则使用代码内示例地址。

**预期：** 控制台输出当前网络示例地址的 TRX 余额，无报错即通过。

**验证点：** `BalanceProvider::get_balance`、Tron RPC 连通性。

---

### 2. tron-trc20 — TRC20 代币信息与构建转账

**命令：**
```bash
export TRC20_CONTRACT_ADDRESS=TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf  # 可选
cargo run -- tron-trc20
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `TRC20_CONTRACT_ADDRESS` | 否 | Nile 上的 TRC20 合约地址；未设置时从 SDK 读取 `TronNetwork::Nile.usdt_contract()`（Nile USDT） |

**预期：** 依次输出该合约的余额、符号、精度、名称、总供应量，以及“构建 TRC20 转账交易成功”的提示。

**验证点：** `trc20_balance_of`、`trc20_symbol`、`trc20_decimals`、`trc20_name`、`trc20_total_supply`、`trc20_build_transfer`。

---

### 3. tron-usdt-balance — USDT 余额（按 TRON_NETWORK）

**命令：**
```bash
export TRON_ADDRESS=TG2D8vTp4xHBB2vhVbgHK2AhA2p9wY4q9M
cargo run -- tron-usdt-balance
# 主网：export TRON_NETWORK=mainnet && cargo run -- tron-usdt-balance
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `TRON_ADDRESS` | 是 | 要查 USDT 余额的 Tron 地址（Base58） |
| `TRON_NETWORK` | 否 | 网络：`nile`（默认）、`mainnet`、`shasta` |

**预期：** 输出当前网络 USDT 合约地址、该地址的余额（原始值及换算后的 USDT 数量，精度 6）。

**验证点：** 当前网络 RPC、`TronNetwork::*.usdt_contract()`、`trc20_balance_of`。

---

### 4. tron-verify-trc20 — 按 SDK 验证 TRC20 API

**命令：**
```bash
cargo run -- tron-verify-trc20
```

**环境变量：** 无（使用 Nile 测试网及 SDK 内置 Nile USDT 合约地址）。

**预期：** 逐项输出 10 个 SDK TRC20 接口的验证结果（✅/❌），最后一行为“合计: 10 通过, 0 失败”。若有失败则进程退出码为 1。

**验证的 API：** `trc20_balance_of`、`trc20_symbol`、`trc20_decimals`、`trc20_name`、`trc20_total_supply`、`trc20_allowance`、`trc20_token_info`、`trc20_build_transfer`、`trc20_build_approve`、`trc20_build_transfer_from`。

---

### 5. tron-transfer — TRX 原生转账（构建→签名→广播→监听）

**命令：**
```bash
export TRON_PRIVATE_KEY=79a5d62ebbe36b4e54fa5d795de9a2d4c528508a48e004cafbe0660a8d286e08
export TRON_FROM_ADDRESS=TG2D8vTp4xHBB2vhVbgHK2AhA2p9wY4q9M
export TRON_TO_ADDRESS=TPsXm9mBMn8WGoDQcvroGPQbb3WpP7K15t
cargo run -- tron-transfer
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `TRON_PRIVATE_KEY` | 是 | 发送方私钥，64 位十六进制（32 字节），可带 `0x` 前缀 |
| `TRON_FROM_ADDRESS` | 否 | 发送方地址，默认示例地址 |
| `TRON_TO_ADDRESS` | 否 | 接收方地址，默认同 FROM |
| `TRX_AMOUNT_SUN` | 否 | 转账金额（sun），默认 1000（0.001 TRX） |

**预期：** 依次完成“构建 TRX 转账交易 → 本地签名 → 广播 → 等待确认”，并输出交易哈希与最终状态。

---

### 6. tron-full-flow — 全自动 TRC20 流程

**命令：**
```bash
export TRON_PRIVATE_KEY=<64 位十六进制私钥>
export TRC20_CONTRACT_ADDRESS=<Nile 上的 TRC20 合约地址>  # 可选
export TRON_FROM_ADDRESS=...   # 可选
export TRON_TO_ADDRESS=...     # 可选
export TRC20_AMOUNT=1000000    # 可选，最小单位
export TRC20_FEE_LIMIT=100000000  # 可选，sun
cargo run -- tron-full-flow
```

**预期：** 依次完成“构建 TRC20 转账 → 本地签名 → 广播 → 等待确认”，并输出交易哈希与最终状态。

**安全提示：** 私钥仅用于本地签名，不会上传；建议仅在测试网使用，勿泄露私钥。

---

### 7. tron-send-demo — 示例发送（假数据）

**命令：**
```bash
cargo run -- tron-send-demo
```

**环境变量：** 无。

**说明：** 使用内置假 `raw_tx` 调用发送与监听接口，不保证链上成功。

**预期：** 程序不 panic；可能因交易无效而得到发送失败或失败状态，属预期。

---

### 8. tron-send-signed — 发送已签名交易

**命令：**
```bash
# 方式一：环境变量直接传 JSON
export SIGNED_TX_JSON='{"raw_data":{...},"signature":[...]}'
cargo run -- tron-send-signed
```

```bash
# 方式二：从文件读取（推荐）
export SIGNED_TX_PATH=/path/to/signed_tx.json
cargo run -- tron-send-signed
```

**环境变量：** `SIGNED_TX_JSON` 与 `SIGNED_TX_PATH` 二选一。

**预期：** 广播到 Nile，输出交易哈希，并轮询直至确认/失败/超时。

---

### 9. tron-monitor — 监听 Tron 交易确认

**命令：**
```bash
export TX_HASH=<Tron 交易哈希>
cargo run -- tron-monitor
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `TX_HASH` | 是 | 要监听的 Tron 交易哈希（Nile 上存在的交易） |

**预期：** 轮询后输出“交易已确认”或“交易失败”或“仍在等待确认”。

---

## 二、Ethereum / Sepolia 原生 ETH

### 1. eth-balance — 原生 ETH 余额

**命令：**
```bash
export ETH_ADDRESS=0x3CCD11B6c4B5Ca62d2B29C949B23e0550d64f0b9  # 可选
cargo run -- eth-balance
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `EVM_NETWORK` | 否 | `sepolia`（默认）或 `arbitrum-sepolia` |
| `ETH_ADDRESS` | 否 | 要查询的地址（0x 格式），未设置时使用示例地址 `0x3CCD11B6c4B5Ca62d2B29C949B23e0550d64f0b9` |
| `EVM_RPC_URL` | 否 | RPC URL，未设置时从 SDK 备选 RPC 中选取可用节点 |

**预期：** 输出该地址在当前 EVM 网络上的原生 ETH 余额（wei 与 ETH）。

---

### 2. eth-transfer — 原生 ETH 转账全流程

**命令：**
```bash
export ETH_PRIVATE_KEY=<64 位十六进制私钥>
export ETH_TO_ADDRESS=0x1f54Ea7E158849cF49E6EAAE28C0A5B957C7baf0
export ETH_AMOUNT_WEI=1000000000000000  # 可选，默认 0.001 ETH
cargo run -- eth-transfer
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `ETH_PRIVATE_KEY` | 是 | 发送方私钥，64 位十六进制，可带 `0x` 前缀 |
| `ETH_FROM_ADDRESS` | 否 | 发送方地址，未设置时由私钥推导 |
| `ETH_TO_ADDRESS` | 否 | 接收方地址，默认示例地址 |
| `ETH_AMOUNT_WEI` | 否 | 转账金额（wei），默认 1000000000000000（0.001 ETH） |
| `EVM_RPC_URL` | 否 | RPC URL，未设置时从当前 `EVM_NETWORK` 备选列表自动选取 |

**预期：** 依次完成“构建原生 ETH 转账 → 签名 → 广播 → 等待确认”。Arbitrum Sepolia 水龙头：https://faucet.quicknode.com/arbitrum/sepolia

---

### 3. eth-monitor — 监听 Sepolia 交易（ETH/ERC20）

**命令：**
```bash
export TX_HASH=0x683ab7b8b1f8e2643f82e3351e48dee0b452a14ae4473dad90fc28ecacd84314
cargo run -- eth-monitor
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `TX_HASH` | 是 | 要监听的 Sepolia 交易哈希（0x 格式） |
| `EVM_RPC_URL` | 否 | Sepolia RPC，未设置时从 SDK 备选列表中选取 |
| `MONITOR_TIMEOUT_SEC` | 否 | 超时秒数，默认 120 |
| `MONITOR_MIN_CONFIRMATIONS` | 否 | 最少确认数，默认 1 |

**预期：** 轮询后输出“交易已确认”或“交易失败”或“超时仍未确认”。

---

## 三、ERC20 (Sepolia)

### 1. erc20-demo — ERC20 代币信息与构建转账

**命令：**
```bash
export ERC20_CONTRACT_ADDRESS=0x...   # 可选，未设置时使用 SDK EvmNetwork::Sepolia.usdt_contract()
export EVM_RPC_URL=https://rpc.sepolia.org  # 可选
export EVM_NETWORK=arbitrum-sepolia  # 可选
cargo run -- erc20-demo
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `ERC20_CONTRACT_ADDRESS` | 否 | Sepolia 上的 ERC20 合约地址，未设置时使用 SDK `EvmNetwork::Sepolia.usdt_contract()` |
| `EVM_RPC_URL` | 否 | Sepolia RPC，未设置时从备选列表自动选取 |

**预期：** 输出该合约的余额、符号、精度、名称、总供应量，以及“构建 ERC20 转账交易成功”的提示。

---

### 2. erc20-verify — 按 SDK 验证 ERC20 API

**命令：**
```bash
cargo run -- erc20-verify
```

**环境变量：** 无（使用 Sepolia 及 SDK 默认合约）；可选设置 `ERC20_CONTRACT_ADDRESS`、`EVM_RPC_URL`。

**预期：** 逐项输出 10 个 SDK ERC20 接口的验证结果（✅/❌）。

---

### 3. erc20-full-flow — 全自动 ERC20 流程

**命令：**
```bash
export EVM_NETWORK=arbitrum-sepolia
export ETH_PRIVATE_KEY=98f16b84579621f391a1589626c057fa0a54630b9f792e6db4a8493229de089d
export ETH_FROM_ADDRESS=0x3CCD11B6c4B5Ca62d2B29C949B23e0550d64f0b9  
export ETH_TO_ADDRESS=0x1f54Ea7E158849cF49E6EAAE28C0A5B957C7baf0
export ERC20_AMOUNT=120  
cargo run -- erc20-full-flow
```

**环境变量：**

| 变量 | 必填 | 说明 |
|------|------|------|
| `ETH_PRIVATE_KEY` | 是 | 发送方私钥，64 位十六进制 |
| `ERC20_CONTRACT_ADDRESS` | 否 | Sepolia 上的 ERC20 合约，未设置时使用 SDK 默认 |
| `ETH_FROM_ADDRESS` | 否 | 发送方地址 |
| `ETH_TO_ADDRESS` | 否 | 接收方地址 |
| `ERC20_AMOUNT` | 否 | 代币数量（如 120 表示 120 USDT），按合约精度自动换算为最小单位 |
| `EVM_RPC_URL` | 否 | Sepolia RPC |

**预期：** 依次完成“构建 ERC20 转账（按精度换算金额）→ 签名 → 广播 → 等待确认”。

**说明：** `ERC20_AMOUNT=120` 表示 120 个代币单位（如 120 USDT），程序会从合约读取 `decimals` 并换算为最小单位再发起转账。

**安全提示：** 私钥仅用于本地签名，不会上传；建议仅在测试网使用，勿泄露私钥。

---

## 推荐测试顺序

1. **Tron 连通性与只读：** `tron-balance` → `tron-verify-trc20` → `tron-trc20`
2. **Tron 主网只读（可选）：** `tron-usdt-balance`（需设置 `TRON_ADDRESS`）
3. **Tron 转账与监听：** `tron-transfer`（需 `TRON_PRIVATE_KEY`）→ `tron-monitor`（需 `TX_HASH`）→ `tron-full-flow`
4. **Sepolia 连通性与只读：** `eth-balance` → `erc20-verify` → `erc20-demo`
5. **Sepolia 转账与监听：** `eth-transfer`（需 `ETH_PRIVATE_KEY`）→ `erc20-full-flow`（需 `ETH_PRIVATE_KEY`、`ERC20_AMOUNT` 等）→ `eth-monitor`（需 `TX_HASH`）

---

## 常见问题

- **选择网络：** Tron 用 `TRON_NETWORK=nile|mainnet|shasta`（默认 nile）；EVM 用 `EVM_NETWORK=sepolia|arbitrum-sepolia|arbitrum-one|mainnet`（默认 sepolia）。
- **未设置 TRC20_CONTRACT_ADDRESS：** 运行 `tron-trc20` 时不设则使用当前 `TRON_NETWORK` 对应网络的 SDK 默认 USDT 合约。
- **triggerSmartContract missing transaction：** 多为合约地址不属于当前网络（如把主网 USDT 地址用在 Nile），请改用当前网络上的合约地址或确认 `TRON_NETWORK` 与合约一致。
- **TRON_PRIVATE_KEY / ETH_PRIVATE_KEY 格式：** 必须为 32 字节私钥的 64 位十六进制；若只有助记词，需先用钱包或工具导出私钥 hex 再填入。
- **insufficient funds for gas（Sepolia）：** 链上从「私钥对应地址」扣 gas。若报 balance 0，请确认 `ETH_PRIVATE_KEY` 对应的地址在 Sepolia 上有原生 ETH（可从水龙头领取），或私钥与您认为有余额的地址一致。运行 `erc20-full-flow` 时会打印「私钥对应地址」便于核对。
- **verify-trc20 / erc20-verify 失败：** 检查网络是否可访问对应 RPC；若部分项失败，可根据输出中的错误信息排查 SDK 或网络问题。
- **查看所有命令：** `cargo run -- help` 或 `cargo run -- -h`。
- **Sepolia RPC 超时或不可用：** 可手动设置 `EVM_RPC_URL`（如 `https://rpc.sepolia.org`）；未设置时程序会自动尝试 SDK 备选 RPC。
- **EVM 多网络：** `EVM_NETWORK=arbitrum-sepolia`（Arbitrum Sepolia）、`arbitrum-one`（Arbitrum One 主网）、`mainnet`（以太坊主网）时，所有 `eth-*`、`erc20-*` 命令均使用对应网络；各网络默认 ERC20 合约见 SDK `EvmNetwork`。

---

## 相关文档

- **README.md** — 项目介绍与快速运行说明  
- **测试覆盖.md** — 测试覆盖范围与验证点说明（若存在则与本文档互补）
